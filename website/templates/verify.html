<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Verification</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .debug-info { background:#f8f9fa;border-left:4px solid #3498db;padding:15px;margin:15px 0;border-radius:5px;font-family:monospace;font-size:12px;display:none;}
        .debug-toggle { background:#3498db;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:11px;float:right;}
        .error-details { background:#f8d7da;color:#721c24;padding:10px;border-radius:5px;margin:10px 0;font-size:12px;display:none;}
        .verification-status { background:#e8f5e9;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #2ecc71;}
        .btn-test { background:#f39c12;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin:5px;}
    </style>
</head>

<body>
<!-- Store dynamic data in hidden elements -->
<div id="app-data" style="display: none;" 
     data-has-discord-user="{% if discord_user %}true{% else %}false{% endif %}"
     data-is-verified="{% if is_verified %}true{% else %}false{% endif %}"
     data-csrf-token="{{ csrf_token or '' }}">
</div>

<div class="verification-container">
<div class="verification-card">

<div class="verification-header">
    <i class="fas fa-shield-check fa-3x"></i>
    <h1>Discord Verification</h1>
    <p class="subtitle">Connect your Discord account</p>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
</div>

<div id="debugInfo" class="debug-info">
    Session ID: {{ session.get('_id', 'none') }}<br>
    Discord User: {% if discord_user %}YES{% else %}NO{% endif %}<br>
    Verified: {% if is_verified %}YES{% else %}NO{% endif %}<br>
    CSRF: {% if csrf_token %}OK{% else %}MISSING{% endif %}
</div>

<div class="verification-body">

{% if not discord_user %}
    <a href="{{ url_for('auth_discord') }}" class="btn-discord">
        <i class="fab fa-discord"></i> Login with Discord
    </a>

{% elif is_verified %}
    <div class="verification-status">
        <h3>✅ Already Verified</h3>
        <p>You are already verified. Return to Discord.</p>
        <a href="{{ url_for('auth_logout') }}" class="btn-logout">Use another account</a>
    </div>

{% else %}
    <h3>Ready to Verify</h3>
    <button id="startVerification" class="btn-verify" onclick="startVerification()">
        <i class="fas fa-check-circle"></i> Start Verification
    </button>
{% endif %}

<div id="verificationResult"></div>
<div id="errorDetails" class="error-details"></div>

</div>

</div>
</div>

<script>
/* ======================
   GET DATA FROM HTML
====================== */
function getAppData() {
    const appData = document.getElementById('app-data');
    return {
        HAS_DISCORD_USER: appData.dataset.hasDiscordUser === 'true',
        IS_VERIFIED: appData.dataset.isVerified === 'true',
        CSRF_TOKEN: appData.dataset.csrfToken
    };
}

/* ======================
   UI HELPERS
====================== */
function toggleDebug() {
    const d = document.getElementById('debugInfo');
    d.style.display = d.style.display === 'none' ? 'block' : 'none';
}

function showResult(type, title, message) {
    document.getElementById('verificationResult').innerHTML = `
        <div style="padding:15px;border-radius:8px;background:#f8f9fa;border-left:4px solid #3498db">
            <h3>${title}</h3>
            <p>${message}</p>
        </div>
    `;
}

function showErrorDetails(msg) {
    const e = document.getElementById('errorDetails');
    e.innerHTML = msg;
    e.style.display = 'block';
}

/* ======================
   MAIN VERIFICATION
====================== */
async function startVerification() {
    const data = getAppData();
    const btn = document.getElementById('startVerification');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

    try {
        if (!data.CSRF_TOKEN || data.CSRF_TOKEN.length < 10) {
            throw new Error("Missing CSRF token");
        }

        const res = await fetch("/api/verify", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": data.CSRF_TOKEN
            },
            body: JSON.stringify({})
        });

        const responseData = await res.json();

        if (responseData.success) {
            showResult("success", "Verified!", "✅ Verification successful. Reloading...");
            setTimeout(() => location.reload(), 2000);
        } else if (responseData.already_verified) {
            showResult("info", "Already Verified", "You are already verified.");
            setTimeout(() => location.reload(), 2000);
        } else if (responseData.requires_oauth) {
            showResult("error", "Login Required",
                `<a href="${window.location.origin}/auth/discord" class="btn-discord">
                    <i class="fab fa-discord"></i> Login with Discord
                </a>`
            );
        } else {
            throw new Error(responseData.error || "Verification failed");
        }

    } catch (err) {
        showResult("error", "Error", err.message);
        showErrorDetails(err.stack || err.toString());
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Start Verification';
    }
}

/* ======================
   INIT
====================== */
document.addEventListener("DOMContentLoaded", () => {
    const data = getAppData();
    console.log("Loaded");
    console.log("Discord user:", data.HAS_DISCORD_USER);
    console.log("Verified:", data.IS_VERIFIED);
});
</script>

</body>
</html>